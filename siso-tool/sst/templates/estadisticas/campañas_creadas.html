{% extends 'base.html' %}

{% block title %}Campa침as Creadas{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Campa침as Creadas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container mt-4">
    <h2 class="text-center mb-4 fw-bold text-primary">游늶 Campa침as Creadas</h2>

    <!-- Tabla de campa침as -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle text-center">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>C칩digo</th>
            <th>Nombre</th>
            <th>Actividad</th>
            <th>Multimedia</th>
            <th>Horario</th>
            <th>Evidencia</th>
            <th>Estado</th>
            <th>Grupo</th>
            <th>Fecha de Creaci칩n</th>
          </tr>
        </thead>
        <tbody>
          {% for campa침a in campa침as %}
          <tr>
            <td>{{ campa침a.id }}</td>
            <td>{{ campa침a.codigo.codigo }}</td>
            <td>{{ campa침a.codigo.nombre }}</td>

            <!-- Actividad -->
            <td>
              {% if campa침a.actividad %}
                {{ campa침a.actividad.nombre }}
              {% else %}
                <span class="text-muted">No asignada</span>
              {% endif %}
            </td>

            <!-- Multimedia -->
            <td>
              {% if campa침a.multimedia %}
                <a href="{{ campa침a.multimedia.url }}" target="_blank" class="text-decoration-none">
                  Ver recurso
                </a>
              {% else %}
                <span class="text-muted">No aplica</span>
              {% endif %}
            </td>

            <!-- Horario -->
            <td>
              {% if campa침a.horario_inicio %}
                {{ campa침a.horario_inicio|time:"H:i" }}
              {% else %}
                <span class="text-muted">No definido</span>
              {% endif %}
            </td>

            <!-- Evidencia -->
            <td>
              {% if campa침a.evidencia_requerida %}
                <span class="badge bg-info">S칤</span>
              {% else %}
                <span class="badge bg-light text-dark">No</span>
              {% endif %}
            </td>

            <!-- Estado -->
            <td>
              {% if campa침a.estado == 'activa' %}
                <span class="badge bg-success">Activa</span>
              {% elif campa침a.estado == 'pausada' %}
                <span class="badge bg-warning text-dark">Pausada</span>
              {% elif campa침a.estado == 'finalizada' %}
                <span class="badge bg-secondary">Finalizada</span>
              {% else %}
                <span class="badge bg-light text-dark">{{ campa침a.estado }}</span>
              {% endif %}
            </td>

            <!-- Grupos -->
            <td>
              {% if campa침a.grupos.all %}
                {% for grupo in campa침a.grupos.all %}
                  {{ grupo.nombre }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                  <span class="text-muted">Sin grupo</span>
                {% endfor %}
              {% else %}
                <span class="text-muted">Sin grupo</span>
              {% endif %}
            </td>

            <!-- Fecha -->
            <td>{{ campa침a.fecha_creacion|date:"Y-m-d H:i" }}</td>
          </tr>

          {% empty %}
          <tr>
            <td colspan="10" class="text-center text-muted">No hay campa침as creadas.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Gr치fico -->
    <div class="my-5">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="text-success">游늵 Resumen de Campa침as</h4>
        <div>
          <select id="estadoFiltro" class="form-select">
            <option value="todos">Todos</option>
            <option value="activa">Activa</option>
            <option value="pausada">Pausada</option>
            <option value="finalizada">Finalizada</option>
          </select>
        </div>
      </div>
      <canvas id="graficoCampanias" height="100"></canvas>
    </div>

    <!-- Bot칩n volver -->
    <div class="text-center mt-4">
      <a href="{% url 'estadisticas_campa침as' %}" class="btn btn-outline-primary">
        <i class="bi bi-arrow-left-circle"></i> Volver
      </a>
    </div>
  </div>

  <script>
    const campa침as = JSON.parse('{{ campa침as_json|escapejs }}');
    const nombresOriginal = campa침as.map(c => c.nombre);
    const estadosOriginal = campa침as.map(c => c.estado);
    const periodicidadesOriginal = campa침as.map(c => c.periodicidad);

    const estadoColores = {
      'activa': 'rgba(40, 167, 69, 0.7)',
      'pausada': 'rgba(255, 193, 7, 0.7)',
      'finalizada': 'rgba(108, 117, 125, 0.7)',
      'otro': 'rgba(100, 100, 255, 0.7)'
    };

    const ctx = document.getElementById('graficoCampanias').getContext('2d');

    let chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: nombresOriginal,
        datasets: [{
          label: 'Campa침as',
          data: periodicidadesOriginal.map(() => 1),
          backgroundColor: estadosOriginal.map(e => estadoColores[e] || estadoColores['otro'])
        }]
      },
      options: {
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const i = context.dataIndex;
                return `Estado: ${estadosOriginal[i]} | Periodicidad: ${periodicidadesOriginal[i]}`;
              }
            }
          },
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Cantidad (por campa침a)'
            },
            ticks: { stepSize: 1, precision: 0 }
          },
          x: {
            title: {
              display: true,
              text: 'Nombre de la campa침a'
            }
          }
        }
      }
    });

    // Filtrado din치mico
    document.getElementById('estadoFiltro').addEventListener('change', function () {
      const estadoSeleccionado = this.value;
      let filteredNombres = [];
      let filteredPeriodicidades = [];
      let filteredEstados = [];

      nombresOriginal.forEach((nombre, index) => {
        const estado = estadosOriginal[index];
        if (estadoSeleccionado === 'todos' || estado === estadoSeleccionado) {
          filteredNombres.push(nombre);
          filteredPeriodicidades.push(1);
          filteredEstados.push(estado);
        }
      });

      chart.data.labels = filteredNombres;
      chart.data.datasets[0].data = filteredPeriodicidades;
      chart.data.datasets[0].backgroundColor = filteredEstados.map(e => estadoColores[e] || estadoColores['otro']);
      chart.update();
    });
  </script>
</body>
</html>
{% endblock %}
